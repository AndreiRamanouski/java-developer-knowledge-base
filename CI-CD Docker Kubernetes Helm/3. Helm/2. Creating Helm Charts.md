
## 1. Chart Development

### helm create (Scaffold)

**Create a new chart from template:**

```bash
# Create chart scaffold
helm create myapp

# Generated structure:
myapp/
├── Chart.yaml
├── values.yaml
├── charts/
├── templates/
│   ├── deployment.yaml
│   ├── service.yaml
│   ├── ingress.yaml
│   ├── serviceaccount.yaml
│   ├── hpa.yaml
│   ├── NOTES.txt
│   ├── _helpers.tpl
│   └── tests/
│       └── test-connection.yaml
└── .helmignore
```

**Scaffold includes:**

- ✅ Basic deployment
- ✅ Service
- ✅ Ingress (disabled by default)
- ✅ Horizontal Pod Autoscaler (disabled)
- ✅ ServiceAccount
- ✅ Helper templates
- ✅ Test connection

**Customize scaffold:**

```bash
# Lint chart (validate)
helm lint myapp/

# Test rendering (dry-run)
helm template myapp ./myapp

# Template with values
helm template myapp ./myapp --values values-prod.yaml

# Debug rendering
helm template myapp ./myapp --debug

# Install locally
helm install myapp ./myapp --dry-run --debug
```

---

### Template Syntax (Go Templating)

Helm uses **Go template** language with additional functions.

#### Basic Syntax

```yaml
# {{ }} - Template directive (output)
apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}

# {{- }} - Trim whitespace left
{{- if .Values.enabled }}
enabled: true
{{- end }}

# {{ -}} - Trim whitespace right
{{ .Values.name -}}

# {{/* */}} - Comment (not rendered)
{{/* This is a comment */}}
```

#### Whitespace Control

```yaml
# Without whitespace control:
apiVersion: v1
{{ if .Values.enabled }}
enabled: true
{{ end }}

# Renders as:
apiVersion: v1

enabled: true


# With whitespace control:
apiVersion: v1
{{- if .Values.enabled }}
enabled: true
{{- end }}

# Renders as:
apiVersion: v1
enabled: true
```

**Whitespace Rules:**

```yaml
{{-   # Trim left whitespace
-}}   # Trim right whitespace

# Examples:
{{ .Value }}      # No trimming
{{- .Value }}     # Trim spaces before
{{ .Value -}}     # Trim spaces after
{{- .Value -}}    # Trim both sides
```

---

### Built-in Objects

#### 1. .Values (values.yaml)

Access values from values.yaml:

```yaml
# values.yaml
replicaCount: 3
image:
  repository: nginx
  tag: "1.25"

service:
  type: ClusterIP
  port: 80
```

```yaml
# templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
spec:
  replicas: {{ .Values.replicaCount }}
  template:
    spec:
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
```

**Accessing nested values:**

```yaml
{{ .Values.image.repository }}              # nginx
{{ .Values.service.port }}                  # 80
{{ index .Values "service" "port" }}        # Alternative syntax
```

#### 2. .Release (Release information)

```yaml
# Release object properties:
{{ .Release.Name }}        # Release name (e.g., "myapp")
{{ .Release.Namespace }}   # Namespace (e.g., "production")
{{ .Release.IsUpgrade }}   # Boolean: Is this an upgrade?
{{ .Release.IsInstall }}   # Boolean: Is this an install?
{{ .Release.Revision }}    # Revision number (e.g., 1, 2, 3)
{{ .Release.Service }}     # "Helm" (always)
```

**Example usage:**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    release: {{ .Release.Name }}
    revision: {{ .Release.Revision | quote }}
data:
  environment: {{ .Release.Namespace }}
```

#### 3. .Chart (Chart.yaml metadata)

```yaml
# Chart.yaml
apiVersion: v2
name: myapp
version: 1.0.0
appVersion: "1.2.3"
description: My application
```

```yaml
# Template access:
{{ .Chart.Name }}        # myapp
{{ .Chart.Version }}     # 1.0.0
{{ .Chart.AppVersion }}  # 1.2.3
{{ .Chart.Description }} # My application
```

**Example:**

```yaml
apiVersion: v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
```

#### 4. .Files (Access files)

```yaml
# Read file contents
{{ .Files.Get "config/app.conf" }}

# Read as bytes
{{ .Files.GetBytes "config/app.conf" | b64enc }}

# Check if file exists
{{ if .Files.Glob "config/*.conf" }}
  # files exist
{{ end }}

# Iterate over files
{{ range .Files.Lines "config/hosts.txt" }}
  {{ . }}
{{ end }}
```

#### 5. .Capabilities (Cluster capabilities)

```yaml
# Kubernetes version
{{ .Capabilities.KubeVersion }}        # v1.28.0
{{ .Capabilities.KubeVersion.Major }}  # 1
{{ .Capabilities.KubeVersion.Minor }}  # 28

# API versions available
{{ if .Capabilities.APIVersions.Has "apps/v1" }}
  # Use apps/v1
{{ end }}

# Example: Conditional API version
{{- if .Capabilities.APIVersions.Has "networking.k8s.io/v1" }}
apiVersion: networking.k8s.io/v1
{{- else }}
apiVersion: networking.k8s.io/v1beta1
{{- end }}
kind: Ingress
```

#### 6. .Template (Template information)

```yaml
{{ .Template.Name }}      # Current template name
{{ .Template.BasePath }}  # Base path of templates
```

---

### Template Functions and Pipelines

#### String Functions

```yaml
# Case conversion
{{ upper "hello" }}              # HELLO
{{ lower "WORLD" }}              # world
{{ title "hello world" }}        # Hello World

# Trimming
{{ trim "  hello  " }}           # hello
{{ trimPrefix "pre-" "pre-fix" }} # fix
{{ trimSuffix "-suf" "pre-suf" }} # pre

# Replacement
{{ replace "." "-" "1.2.3" }}    # 1-2-3

# Substring
{{ substr 0 5 "hello world" }}   # hello

# Repeat
{{ repeat 3 "ha" }}              # hahaha

# Quoting
{{ quote "value" }}              # "value"
{{ squote "value" }}             # 'value'
```

#### Type Conversion

```yaml
# To string
{{ toString 123 }}               # "123"
{{ toString true }}              # "true"

# To integer
{{ int "42" }}                   # 42
{{ int64 "42" }}                 # 42 (64-bit)

# To float
{{ float64 "3.14" }}             # 3.14

# To YAML
{{ .Values | toYaml }}

# To JSON
{{ .Values | toJson }}
{{ .Values | toPrettyJson }}

# To TOML
{{ .Values | toToml }}

# From JSON
{{ .Values.jsonString | fromJson }}
```

#### Default Values

```yaml
# Provide default if value is empty
{{ .Values.image.tag | default "latest" }}
{{ .Values.replicas | default 1 }}

# Multiple defaults (first non-empty)
{{ .Values.primary | default .Values.secondary | default "fallback" }}

# Required (fail if empty)
{{ required "image.tag is required" .Values.image.tag }}
```

#### Encoding/Decoding

```yaml
# Base64
{{ "hello" | b64enc }}           # aGVsbG8=
{{ "aGVsbG8=" | b64dec }}        # hello

# URL encoding
{{ "hello world" | urlquery }}   # hello+world
```

#### Cryptographic Functions

```yaml
# SHA256
{{ "password" | sha256sum }}

# Generate random strings
{{ randAlphaNum 16 }}            # Random 16-char string
{{ randAlpha 10 }}               # Random 10 letters
{{ randNumeric 6 }}              # Random 6 digits

# UUID
{{ uuidv4 }}                     # Generate UUID
```

#### Date Functions

```yaml
# Current time
{{ now }}                        # 2024-11-14 10:30:00
{{ now | date "2006-01-02" }}   # 2024-11-14
{{ now | date "15:04:05" }}     # 10:30:00

# Date arithmetic
{{ now | dateModify "+24h" }}    # Tomorrow
{{ now | dateModify "-7d" }}     # Week ago

# Unix timestamp
{{ now | unixEpoch }}            # 1700000000
```

#### Math Functions

```yaml
# Basic operations
{{ add 1 2 }}                    # 3
{{ sub 5 3 }}                    # 2
{{ mul 4 5 }}                    # 20
{{ div 10 2 }}                   # 5
{{ mod 10 3 }}                   # 1

# Multiple arguments
{{ add 1 2 3 4 }}                # 10

# Min/Max
{{ max 1 2 3 }}                  # 3
{{ min 1 2 3 }}                  # 1

# Round
{{ ceil 3.2 }}                   # 4
{{ floor 3.8 }}                  # 3
{{ round 3.5 2 }}                # 3.50 (2 decimals)
```

#### List Functions

```yaml
# Create list
{{ list 1 2 3 }}                 # [1 2 3]

# Append
{{ append (list 1 2) 3 }}        # [1 2 3]

# Concatenate
{{ concat (list 1 2) (list 3 4) }} # [1 2 3 4]

# Has element
{{ has 2 (list 1 2 3) }}         # true

# First/Last
{{ first (list 1 2 3) }}         # 1
{{ last (list 1 2 3) }}          # 3

# Rest (all but first)
{{ rest (list 1 2 3) }}          # [2 3]

# Initial (all but last)
{{ initial (list 1 2 3) }}       # [1 2]

# Reverse
{{ reverse (list 1 2 3) }}       # [3 2 1]

# Unique
{{ uniq (list 1 2 2 3) }}        # [1 2 3]

# Compact (remove empty)
{{ compact (list 1 "" 2 nil 3) }} # [1 2 3]
```

#### Dictionary Functions

```yaml
# Create dictionary
{{ dict "key1" "value1" "key2" "value2" }}

# Get value
{{ index .Values "service" "port" }}
{{ pluck "port" .Values.service }}

# Set value
{{ set .Values "newKey" "newValue" }}

# Delete key
{{ unset .Values "oldKey" }}

# Has key
{{ hasKey .Values "service" }}    # true

# Keys
{{ keys .Values }}                # [service image replicas]

# Merge dictionaries
{{ merge dict1 dict2 }}

# Deep copy
{{ deepCopy .Values }}
```

---

### Pipelines

**Pipe output from one function to another:**

```yaml
# Basic pipeline
{{ .Values.name | upper }}
# Same as: {{ upper .Values.name }}

# Multiple pipes
{{ .Values.name | upper | quote }}
# "NGINX"

# Complex pipeline
{{ .Values.image.tag | default .Chart.AppVersion | quote }}

# Pipeline with multiple arguments
{{ .Values.text | replace "." "-" | upper }}
```

**Pipeline Examples:**

```yaml
# Example 1: Image tag with fallback
image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"

# Example 2: Required value with formatting
database: {{ required "database.host is required" .Values.database.host | quote }}

# Example 3: Indentation with YAML
env:
{{ .Values.env | toYaml | nindent 2 }}

# Example 4: Conditional with default
replicas: {{ .Values.replicaCount | default 3 }}

# Example 5: List processing
{{- range .Values.hosts | uniq | sortAlpha }}
- {{ . }}
{{- end }}
```

---

### Control Structures

#### if/else

```yaml
# Simple if
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
# ... ingress config
{{- end }}

# if/else
{{- if .Values.service.type }}
type: {{ .Values.service.type }}
{{- else }}
type: ClusterIP
{{- end }}

# if/else if/else
{{- if eq .Values.environment "production" }}
replicas: 10
{{- else if eq .Values.environment "staging" }}
replicas: 3
{{- else }}
replicas: 1
{{- end }}

# Multiple conditions (and)
{{- if and .Values.ingress.enabled .Values.ingress.tls }}
tls:
  - secretName: {{ .Values.ingress.tls.secretName }}
{{- end }}

# Multiple conditions (or)
{{- if or .Values.dev .Values.staging }}
debug: true
{{- end }}

# Not condition
{{- if not .Values.production }}
debug: true
{{- end }}
```

**Comparison Operators:**

```yaml
# Equality
{{ if eq .Values.env "prod" }}      # Equal
{{ if ne .Values.env "dev" }}       # Not equal

# Numeric comparison
{{ if lt .Values.replicas 5 }}      # Less than
{{ if le .Values.replicas 5 }}      # Less than or equal
{{ if gt .Values.replicas 1 }}      # Greater than
{{ if ge .Values.replicas 1 }}      # Greater than or equal

# Boolean
{{ if .Values.enabled }}            # True if not nil/false/0/""
{{ if not .Values.disabled }}       # Negation

# Complex
{{ if and (eq .Values.env "prod") (gt .Values.replicas 1) }}
# Production AND replicas > 1
{{ end }}
```

#### range (Loops)

```yaml
# Loop over list
env:
{{- range .Values.env }}
- name: {{ .name }}
  value: {{ .value }}
{{- end }}

# Loop with index
{{- range $index, $value := .Values.hosts }}
- host: {{ $value }}
  index: {{ $index }}
{{- end }}

# Loop over dictionary
{{- range $key, $value := .Values.labels }}
{{ $key }}: {{ $value }}
{{- end }}

# Loop with root context
{{- range .Values.services }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $.Release.Name }}-{{ .name }}  # Note: $. for root
spec:
  ports:
  - port: {{ .port }}
{{- end }}
```

**Loop Examples:**

```yaml
# Example 1: Environment variables
# values.yaml:
env:
  - name: LOG_LEVEL
    value: INFO
  - name: DATABASE_HOST
    value: postgres

# Template:
env:
{{- range .Values.env }}
- name: {{ .name }}
  value: {{ .value | quote }}
{{- end }}

# Example 2: Multiple hosts
# values.yaml:
ingress:
  hosts:
    - api.example.com
    - www.example.com

# Template:
rules:
{{- range .Values.ingress.hosts }}
- host: {{ . }}
  http:
    paths:
    - path: /
      pathType: Prefix
{{- end }}

# Example 3: ConfigMap from files
# values.yaml:
config:
  app.properties: |
    server.port=8080
  log.properties: |
    logging.level=INFO

# Template:
data:
{{- range $key, $value := .Values.config }}
  {{ $key }}: |
{{ $value | indent 4 }}
{{- end }}
```

#### with (Scope)

```yaml
# Change scope for template section
{{- with .Values.service }}
apiVersion: v1
kind: Service
metadata:
  name: {{ $.Release.Name }}-service  # Note: $ for root
spec:
  type: {{ .type }}      # .type in .Values.service scope
  ports:
  - port: {{ .port }}    # .port in .Values.service scope
{{- end }}

# With conditional
{{- with .Values.nodeSelector }}
nodeSelector:
{{ toYaml . | indent 2 }}
{{- end }}

# Without 'with' (verbose):
{{- if .Values.nodeSelector }}
nodeSelector:
{{ toYaml .Values.nodeSelector | indent 2 }}
{{- end }}
```

---

### Complete Template Example

```yaml
# templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "myapp.fullname" . }}
  labels:
    {{- include "myapp.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "myapp.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "myapp.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "myapp.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        {{- range .Values.service.ports }}
        - name: {{ .name }}
          containerPort: {{ .targetPort | default .port }}
          protocol: {{ .protocol | default "TCP" }}
        {{- end }}
        {{- if .Values.env }}
        env:
        {{- range .Values.env }}
        - name: {{ .name }}
          {{- if .value }}
          value: {{ .value | quote }}
          {{- else if .valueFrom }}
          valueFrom:
            {{- toYaml .valueFrom | nindent 12 }}
          {{- end }}
        {{- end }}
        {{- end }}
        {{- with .Values.livenessProbe }}
        livenessProbe:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .Values.readinessProbe }}
        readinessProbe:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
```

---

## 2. Values and Overrides

### Default values.yaml

**Comprehensive values.yaml structure:**

```yaml
# values.yaml
# Global values (shared with subcharts)
global:
  imageRegistry: ""
  imagePullSecrets: []

# Replica count
replicaCount: 3

# Image configuration
image:
  repository: myapp
  pullPolicy: IfNotPresent
  tag: ""  # Defaults to Chart.AppVersion

# Environment variables
env:
  - name: ENVIRONMENT
    value: production
  - name: LOG_LEVEL
    value: INFO
  - name: DATABASE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: password

# Service configuration
service:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 8080
    - name: metrics
      port: 9090
      targetPort: 9090

# Ingress
ingress:
  enabled: false
  className: nginx
  annotations: {}
  hosts:
    - host: myapp.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []

# Resources
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# Autoscaling
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

# Probes
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5

# Pod configuration
podAnnotations: {}
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  capabilities:
    drop:
    - ALL

# Node selection
nodeSelector: {}
tolerations: []
affinity: {}

# Service account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# ConfigMap data
configMap:
  data:
    application.yaml: |
      server:
        port: 8080
      logging:
        level: INFO

# Additional manifests
extraManifests: []
```

---

### Environment-Specific Values

**Create values files for each environment:**

```yaml
# values-dev.yaml
replicaCount: 1

image:
  tag: latest
  pullPolicy: Always

env:
  - name: ENVIRONMENT
    value: development
  - name: LOG_LEVEL
    value: DEBUG

ingress:
  enabled: true
  hosts:
    - host: myapp-dev.example.com

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: false
```

```yaml
# values-staging.yaml
replicaCount: 2

image:
  tag: v1.2.3-rc1
  pullPolicy: IfNotPresent

env:
  - name: ENVIRONMENT
    value: staging
  - name: LOG_LEVEL
    value: INFO

ingress:
  enabled: true
  className: nginx
  hosts:
    - host: myapp-staging.example.com
  tls:
    - secretName: myapp-staging-tls
      hosts:
        - myapp-staging.example.com

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
```

```yaml
# values-prod.yaml
replicaCount: 5

image:
  tag: v1.2.3
  pullPolicy: IfNotPresent

env:
  - name: ENVIRONMENT
    value: production
  - name: LOG_LEVEL
    value: WARN
  - name: DATABASE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: prod-db-secret
        key: password

ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
  hosts:
    - host: myapp.example.com
    - host: www.myapp.example.com
  tls:
    - secretName: myapp-prod-tls
      hosts:
        - myapp.example.com
        - www.myapp.example.com

resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 1000m
    memory: 1Gi

autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

podDisruptionBudget:
  enabled: true
  minAvailable: 3
```

---

### --set vs -f Flags

#### Using -f / --values (File-based)

```bash
# Single values file
helm install myapp ./mychart -f values-prod.yaml

# Multiple values files (merged in order)
helm install myapp ./mychart \
  -f values.yaml \
  -f values-prod.yaml \
  -f values-secrets.yaml

# Values files merged left to right
# Later files override earlier ones
```

#### Using --set (Command-line)

```bash
# Set single value
helm install myapp ./mychart --set replicaCount=5

# Set multiple values
helm install myapp ./mychart \
  --set replicaCount=5 \
  --set image.tag=v2.0.0

# Set nested values
helm install myapp ./mychart --set image.tag=v2.0.0

# Set array values
helm install myapp ./mychart \
  --set env[0].name=LOG_LEVEL \
  --set env[0].value=DEBUG

# Set multiple array values
helm install myapp ./mychart \
  --set env[0].name=LOG_LEVEL,env[0].value=DEBUG \
  --set env[1].name=DB_HOST,env[1].value=postgres
```

#### --set Special Cases

```bash
# Null value
helm install myapp ./mychart --set nodeSelector=null

# Boolean
helm install myapp ./mychart --set ingress.enabled=true

# Numbers
helm install myapp ./mychart --set replicaCount=5

# Strings with special characters
helm install myapp ./mychart --set "password=my\,password"  # Escape comma

# Multiple values in one --set
helm install myapp ./mychart \
  --set replicaCount=5,image.tag=v2.0.0,ingress.enabled=true
```

#### --set-file (From file content)

```bash
# Set value from file content
helm install myapp ./mychart \
  --set-file config=config.yaml

# Multiple files
helm install myapp ./mychart \
  --set-file config=config.yaml \
  --set-file cert=tls.crt
```

#### --set-string (Force string type)

```bash
# Force value as string (useful for numeric strings)
helm install myapp ./mychart --set-string nodePort="8080"

# Without --set-string, might be interpreted as number
```

---

### Value Precedence

**Order (highest to lowest priority):**

```
1. --set (command line)
2. --set-file (file content)
3. -f / --values (values files, in order specified)
4. values.yaml (default in chart)
```

**Example:**

```bash
# values.yaml (in chart)
replicaCount: 1
image:
  tag: v1.0.0

# values-prod.yaml
replicaCount: 5
image:
  tag: v2.0.0

# Command
helm install myapp ./mychart \
  -f values-prod.yaml \
  --set replicaCount=10

# Result:
# replicaCount: 10 (from --set, highest priority)
# image.tag: v2.0.0 (from values-prod.yaml)
```

**Merging Behavior:**

```yaml
# values.yaml
service:
  type: ClusterIP
  port: 80
  annotations:
    old: value

# values-prod.yaml
service:
  type: LoadBalancer
  annotations:
    new: value

# Merged result:
service:
  type: LoadBalancer  # Overridden
  port: 80            # Kept from values.yaml
  annotations:
    old: value        # Merged
    new: value        # Added
```

---

## 3. Chart Dependencies

### Chart.yaml Dependencies (Helm 3)

```yaml
# Chart.yaml
apiVersion: v2
name: myapp
version: 1.0.0

dependencies:
  # PostgreSQL database
  - name: postgresql
    version: "12.1.0"
    repository: https://charts.bitnami.com/bitnami
    condition: postgresql.enabled
    tags:
      - database
    import-values:
      - child: image.tag
        parent: postgresqlImageTag
  
  # Redis cache
  - name: redis
    version: "17.3.0"
    repository: https://charts.bitnami.com/bitnami
    condition: redis.enabled
    alias: cache
    tags:
      - cache
  
  # Common library (helper functions)
  - name: common
    version: "2.0.0"
    repository: https://charts.bitnami.com/bitnami
```

**Dependency Management:**

```bash
# Download dependencies
helm dependency update ./mychart

# This creates:
# - charts/postgresql-12.1.0.tgz
# - charts/redis-17.3.0.tgz
# - Chart.lock (lock file)

# List dependencies
helm dependency list ./mychart

# Build dependencies (from Chart.lock)
helm dependency build ./mychart
```

**Chart.lock:**

```yaml
dependencies:
- name: postgresql
  repository: https://charts.bitnami.com/bitnami
  version: 12.1.0
- name: redis
  repository: https://charts.bitnami.com/bitnami
  version: 17.3.0
digest: sha256:abc123...
generated: "2024-11-14T10:00:00Z"
```

---

### Subchart Values

**Access subchart values from parent:**

```yaml
# values.yaml (parent chart)
# Configure PostgreSQL subchart
postgresql:
  enabled: true
  auth:
    username: myapp
    password: secret123
    database: mydb
  primary:
    persistence:
      enabled: true
      size: 10Gi
  resources:
    limits:
      memory: 2Gi
      cpu: 1000m

# Configure Redis subchart (aliased as 'cache')
cache:
  enabled: true
  auth:
    enabled: true
    password: redissecret
  master:
    persistence:
      enabled: false
```

**Override subchart defaults:**

```yaml
# Parent values.yaml
postgresql:
  enabled: true
  # Any value here overrides subchart's values.yaml
  auth:
    postgresPassword: adminpass
    username: appuser
    password: apppass
    database: appdb
  primary:
    resources:
      limits:
        memory: 2Gi
        cpu: 1000m
      requests:
        memory: 1Gi
        cpu: 500m
```

**Subchart access parent values:**

```yaml
# In subchart template:
# Cannot access parent values directly
# But can access global values (see next section)
```

---

### Global Values

**Global values** are shared between parent and all subcharts.

```yaml
# values.yaml (parent)
global:
  imageRegistry: docker.io
  imagePullSecrets:
    - name: regcred
  storageClass: fast-ssd
  postgresql:
    auth:
      postgresPassword: globalpass

# Local values
postgresql:
  enabled: true
  # Subchart gets global.postgresql values automatically
```

**Access in templates:**

```yaml
# Parent chart template
image: "{{ .Values.global.imageRegistry }}/myapp:{{ .Chart.AppVersion }}"

{{- with .Values.global.imagePullSecrets }}
imagePullSecrets:
  {{- toYaml . | nindent 2 }}
{{- end }}

# Subchart template (postgresql)
# Automatically gets global values
image: "{{ .Values.global.imageRegistry }}/postgresql:14"
```

**Global value merging:**

```yaml
# Parent values.yaml
global:
  shared: global-value
  
postgresql:
  global:
    shared: subchart-override  # Can override in subchart config
```

---

### Conditional Dependencies

#### Using condition

```yaml
# Chart.yaml
dependencies:
  - name: postgresql
    version: "12.1.0"
    repository: https://charts.bitnami.com/bitnami
    condition: postgresql.enabled  # Enable/disable via values

  - name: mysql
    version: "9.3.0"
    repository: https://charts.bitnami.com/bitnami
    condition: mysql.enabled
```

```yaml
# values.yaml
# Enable PostgreSQL, disable MySQL
postgresql:
  enabled: true
  auth:
    database: mydb

mysql:
  enabled: false
```

```bash
# Override at install time
helm install myapp ./mychart --set postgresql.enabled=false --set mysql.enabled=true
```

#### Using tags

```yaml
# Chart.yaml
dependencies:
  - name: postgresql
    version: "12.1.0"
    repository: https://charts.bitnami.com/bitnami
    tags:
      - database
  
  - name: mysql
    version: "9.3.0"
    repository: https://charts.bitnami.com/bitnami
    tags:
      - database
  
  - name: redis
    version: "17.3.0"
    repository: https://charts.bitnami.com/bitnami
    tags:
      - cache
```

```yaml
# values.yaml
tags:
  database: true   # Enable all charts with 'database' tag
  cache: false     # Disable all charts with 'cache' tag
```

```bash
# Override tags at install time
helm install myapp ./mychart --set tags.database=false
```

#### Combining condition and tags

```yaml
# Chart.yaml
dependencies:
  - name: postgresql
    version: "12.1.0"
    repository: https://charts.bitnami.com/bitnami
    condition: postgresql.enabled  # Higher priority
    tags:
      - database  # Lower priority
```

**Priority:** condition > tags

```yaml
# values.yaml
tags:
  database: false  # Would disable

postgresql:
  enabled: true    # But condition overrides tag

# Result: PostgreSQL is enabled
```

---

### Import Values

**Import specific values from subchart:**

```yaml
# Chart.yaml
dependencies:
  - name: postgresql
    version: "12.1.0"
    repository: https://charts.bitnami.com/bitnami
    import-values:
      # Import postgresql.image.tag as postgresqlImageTag in parent
      - child: image.tag
        parent: postgresqlImageTag
      
      # Import multiple values
      - child: auth.username
        parent: dbUsername
      - child: auth.database
        parent: dbName
```

```yaml
# Parent values.yaml can now use imported values
postgresqlImageTag: "14.5.0"  # Sets postgresql.image.tag
dbUsername: "myuser"           # Sets postgresql.auth.username
dbName: "mydb"                 # Sets postgresql.auth.database

# Or use in templates
{{ .Values.postgresqlImageTag }}  # Accesses imported value
```

---

### Complete Dependency Example

```yaml
# Chart.yaml
apiVersion: v2
name: myapp
version: 1.0.0
appVersion: "1.0.0"

dependencies:
  # PostgreSQL (required)
  - name: postgresql
    version: "~12.1.0"
    repository: https://charts.bitnami.com/bitnami
    condition: postgresql.enabled
    tags:
      - database
  
  # Redis (optional)
  - name: redis
    version: "^17.0.0"
    repository: https://charts.bitnami.com/bitnami
    condition: redis.enabled
    alias: cache
    tags:
      - cache
  
  # MongoDB (alternative database)
  - name: mongodb
    version: "~13.0.0"
    repository: https://charts.bitnami.com/bitnami
    condition: mongodb.enabled
    tags:
      - database
```

```yaml
# values.yaml
global:
  imageRegistry: docker.io
  imagePullSecrets: []
  storageClass: ""

# Tags (enable/disable groups)
tags:
  database: true
  cache: true

# PostgreSQL configuration
postgresql:
  enabled: true
  auth:
    username: myapp
    password: ""  # Set via --set or secret
    database: myapp
  primary:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: fast-ssd
    resources:
      limits:
        memory: 2Gi
        cpu: 1000m

# Redis configuration
cache:  # Note: using alias 'cache'
  enabled: true
  auth:
    enabled: true
    password: ""
  master:
    persistence:
      enabled: false  # Cache doesn't need persistence

# MongoDB (disabled by default)
mongodb:
  enabled: false
  auth:
    rootPassword: ""
    database: myapp
```

```bash
# Install with dependencies
helm dependency update ./myapp
helm install myapp ./myapp -f values-prod.yaml

# Disable cache
helm install myapp ./myapp --set cache.enabled=false

# Use MongoDB instead of PostgreSQL
helm install myapp ./myapp \
  --set postgresql.enabled=false \
  --set mongodb.enabled=true
```

---

## Summary

### Chart Development

- ✅ Use `helm create` for scaffolding
- ✅ Go template syntax with `{{- }}` for whitespace control
- ✅ Built-in objects: `.Values`, `.Release`, `.Chart`, `.Files`, `.Capabilities`
- ✅ Extensive template functions and pipelines
- ✅ Control structures: `if`, `range`, `with`

### Values and Overrides

- ✅ Default `values.yaml` in chart
- ✅ Environment-specific values files
- ✅ **Precedence**: `--set` > `--values` > `values.yaml`
- ✅ Values merge deeply

### Dependencies

- ✅ Define in `Chart.yaml` (Helm 3)
- ✅ Configure subcharts via parent `values.yaml`
- ✅ Global values shared across all charts
- ✅ Conditional dependencies via `condition` or `tags`
- ✅ Import specific subchart values
