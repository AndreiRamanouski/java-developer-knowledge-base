
## 1. Hooks

**Hooks** allow you to intervene at specific points in a release lifecycle.

### Hook Types and Lifecycle

```
┌────────────────────────────────────────────┐
│         HELM RELEASE LIFECYCLE             │
├────────────────────────────────────────────┤
│                                            │
│  INSTALL:                                  │
│  1. pre-install hooks                      │
│  2. Templates rendered                     │
│  3. Resources created                      │
│  4. post-install hooks                     │
│                                            │
│  UPGRADE:                                  │
│  1. pre-upgrade hooks                      │
│  2. Templates rendered                     │
│  3. Resources updated                      │
│  4. post-upgrade hooks                     │
│                                            │
│  ROLLBACK:                                 │
│  1. pre-rollback hooks                     │
│  2. Resources rolled back                  │
│  3. post-rollback hooks                    │
│                                            │
│  DELETE:                                   │
│  1. pre-delete hooks                       │
│  2. Resources deleted                      │
│  3. post-delete hooks                      │
│                                            │
│  TEST:                                     │
│  1. test hooks (helm test)                 │
│                                            │
└────────────────────────────────────────────┘
```

---

### Hook Annotations

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-pre-install
  annotations:
    # Hook type
    "helm.sh/hook": pre-install
    
    # Hook weight (execution order)
    "helm.sh/hook-weight": "-5"
    
    # Hook deletion policy
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
```

**Available Hooks:**

- `pre-install`: Before resources installed
- `post-install`: After all resources installed
- `pre-upgrade`: Before upgrade
- `post-upgrade`: After upgrade
- `pre-rollback`: Before rollback
- `post-rollback`: After rollback
- `pre-delete`: Before deletion
- `post-delete`: After deletion
- `test`: When `helm test` run

**Hook Weights:**

- Hooks execute in ascending weight order
- Negative weights run first
- Default weight: 0
- Range: any integer

**Hook Deletion Policies:**

- `before-hook-creation`: Delete previous hook before new one
- `hook-succeeded`: Delete after successful execution
- `hook-failed`: Delete after failed execution

---

### pre-install Hook

**Use cases:**

- Create namespace
- Setup prerequisites
- Validate environment
- Create secrets

```yaml
# templates/hooks/pre-install-namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation
  labels:
    created-by: helm
    environment: {{ .Values.environment }}
```

```yaml
# templates/hooks/pre-install-validate.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-pre-install-validate
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  template:
    metadata:
      name: {{ include "mychart.fullname" . }}-pre-install-validate
    spec:
      restartPolicy: Never
      containers:
      - name: pre-install
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Validating environment..."
          
          # Check Kubernetes version
          if [ "$(kubectl version --short | grep Server | cut -d':' -f2 | cut -d'.' -f2)" -lt "24" ]; then
            echo "ERROR: Kubernetes 1.24+ required"
            exit 1
          fi
          
          # Check required resources
          kubectl get storageclass fast-ssd || {
            echo "ERROR: StorageClass 'fast-ssd' not found"
            exit 1
          }
          
          echo "Validation successful!"
```

---

### post-install Hook

**Use cases:**

- Send notifications
- Create default data
- Register service
- Warm up caches

```yaml
# templates/hooks/post-install-notification.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-post-install-notification
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: notify
        image: curlimages/curl:8.4.0
        command:
        - sh
        - -c
        - |
          # Send Slack notification
          curl -X POST {{ .Values.slack.webhookUrl }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "✅ {{ .Release.Name }} deployed to {{ .Release.Namespace }}",
              "username": "Helm",
              "icon_emoji": ":helm:"
            }'
          
          echo "Notification sent!"
```

---

### pre-upgrade / post-upgrade Hooks

```yaml
# templates/hooks/pre-upgrade-backup.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-pre-upgrade-backup
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: backup
        image: postgres:15
        command:
        - sh
        - -c
        - |
          echo "Creating database backup..."
          pg_dump -h {{ .Values.database.host }} \
                  -U {{ .Values.database.username }} \
                  -d {{ .Values.database.name }} \
                  > /backup/db-$(date +%Y%m%d-%H%M%S).sql
          echo "Backup complete!"
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "mychart.fullname" . }}-secret
              key: database-password
        volumeMounts:
        - name: backup
          mountPath: /backup
      volumes:
      - name: backup
        persistentVolumeClaim:
          claimName: backup-pvc
```

```yaml
# templates/hooks/post-upgrade-test.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-post-upgrade-test
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: test
        image: curlimages/curl:8.4.0
        command:
        - sh
        - -c
        - |
          echo "Testing application..."
          
          # Wait for service
          sleep 30
          
          # Health check
          curl -f http://{{ include "mychart.fullname" . }}:80/health || exit 1
          
          # Smoke test
          curl -f http://{{ include "mychart.fullname" . }}:80/api/version || exit 1
          
          echo "Tests passed!"
```

---

### pre-delete / post-delete Hooks

```yaml
# templates/hooks/pre-delete-backup.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-pre-delete-backup
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: final-backup
        image: postgres:15
        command:
        - sh
        - -c
        - |
          echo "Creating final backup before deletion..."
          pg_dump -h {{ .Values.database.host }} \
                  -U {{ .Values.database.username }} \
                  -d {{ .Values.database.name }} \
                  > /backup/final-backup-$(date +%Y%m%d-%H%M%S).sql
          echo "Final backup complete!"
```

```yaml
# templates/hooks/post-delete-cleanup.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-post-delete-cleanup
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "mychart.fullname" . }}-cleanup
      containers:
      - name: cleanup
        image: bitnami/kubectl:1.28
        command:
        - sh
        - -c
        - |
          echo "Cleaning up resources..."
          
          # Delete PVCs (not deleted automatically)
          kubectl delete pvc -l app.kubernetes.io/instance={{ .Release.Name }}
          
          # Deregister from service mesh
          # curl -X DELETE https://servicemesh/deregister/{{ .Release.Name }}
          
          echo "Cleanup complete!"
```

---

### Database Migrations Hook

**Complete migration setup:**

```yaml
# templates/hooks/pre-upgrade-migration.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mychart.fullname" . }}-migration-{{ .Release.Revision }}
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
    app.kubernetes.io/component: migration
  annotations:
    "helm.sh/hook": pre-upgrade,pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "mychart.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    spec:
      restartPolicy: Never
      
      initContainers:
      # Wait for database to be ready
      - name: wait-for-db
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z {{ .Values.database.host }} {{ .Values.database.port }}; do
            echo "Waiting for database..."
            sleep 2
          done
          echo "Database is ready!"
      
      containers:
      # Run Flyway migrations
      - name: flyway
        image: flyway/flyway:9.22
        args:
        - migrate
        - -url=jdbc:postgresql://{{ .Values.database.host }}:{{ .Values.database.port }}/{{ .Values.database.name }}
        - -user={{ .Values.database.username }}
        - -password={{ .Values.database.password }}
        - -locations=filesystem:/flyway/sql
        - -validateMigrationNaming=true
        - -outOfOrder=false
        volumeMounts:
        - name: migrations
          mountPath: /flyway/sql
        env:
        - name: FLYWAY_BASELINE_ON_MIGRATE
          value: "true"
      
      volumes:
      - name: migrations
        configMap:
          name: {{ include "mychart.fullname" . }}-migrations
```

**Migration ConfigMap:**

```yaml
# templates/migrations-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mychart.fullname" . }}-migrations
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
data:
  V1__initial_schema.sql: |
    CREATE TABLE users (
      id SERIAL PRIMARY KEY,
      username VARCHAR(50) NOT NULL UNIQUE,
      email VARCHAR(100) NOT NULL UNIQUE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE INDEX idx_users_username ON users(username);
    CREATE INDEX idx_users_email ON users(email);
  
  V2__add_users_table.sql: |
    CREATE TABLE posts (
      id SERIAL PRIMARY KEY,
      user_id INTEGER REFERENCES users(id),
      title VARCHAR(200) NOT NULL,
      content TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE INDEX idx_posts_user_id ON posts(user_id);
  
  V3__add_status_column.sql: |
    ALTER TABLE users ADD COLUMN status VARCHAR(20) DEFAULT 'active';
    CREATE INDEX idx_users_status ON users(status);
```

---

### Testing Hook

```yaml
# templates/hooks/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "mychart.fullname" . }}-test-connection
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: wget
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      # Test service connectivity
      wget -O- {{ include "mychart.fullname" . }}:{{ .Values.service.port }}/health || exit 1
      echo "Connection test passed!"
```

---

## 2. Testing

### helm test

**Create test pods that validate deployment:**

```bash
# Run tests
helm test myapp

# Output:
NAME: myapp
LAST DEPLOYED: Mon Nov 14 10:00:00 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE:     myapp-test-connection
Last Started:   Mon Nov 14 10:05:00 2024
Last Completed: Mon Nov 14 10:05:10 2024
Phase:          Succeeded

# View test logs
kubectl logs myapp-test-connection
```

---

### Comprehensive Test Suite

```yaml
# templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "mychart.fullname" . }}-test-connection
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: curlimages/curl:8.4.0
    command:
    - sh
    - -c
    - |
      echo "Testing service connectivity..."
      
      # Test health endpoint
      curl -f http://{{ include "mychart.fullname" . }}:{{ .Values.service.port }}/health
      
      # Test readiness
      curl -f http://{{ include "mychart.fullname" . }}:{{ .Values.service.port }}/ready
      
      echo "✓ Connection test passed"
```

```yaml
# templates/tests/test-api.yaml
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "mychart.fullname" . }}-test-api
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: curlimages/curl:8.4.0
    command:
    - sh
    - -c
    - |
      echo "Testing API endpoints..."
      
      BASE_URL="http://{{ include "mychart.fullname" . }}:{{ .Values.service.port }}"
      
      # Test GET endpoint
      echo "Testing GET /api/users"
      curl -f "$BASE_URL/api/users" || exit 1
      
      # Test POST endpoint
      echo "Testing POST /api/users"
      curl -f -X POST "$BASE_URL/api/users" \
        -H "Content-Type: application/json" \
        -d '{"username":"test","email":"test@example.com"}' || exit 1
      
      # Test metrics endpoint
      echo "Testing GET /actuator/metrics"
      curl -f "$BASE_URL/actuator/metrics" || exit 1
      
      echo "✓ API test passed"
```

```yaml
# templates/tests/test-database.yaml
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "mychart.fullname" . }}-test-database
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: postgres:15
    command:
    - sh
    - -c
    - |
      echo "Testing database connectivity..."
      
      # Test connection
      psql -h {{ .Values.database.host }} \
           -U {{ .Values.database.username }} \
           -d {{ .Values.database.name }} \
           -c "SELECT 1;" || exit 1
      
      # Test schema
      psql -h {{ .Values.database.host }} \
           -U {{ .Values.database.username }} \
           -d {{ .Values.database.name }} \
           -c "SELECT table_name FROM information_schema.tables WHERE table_schema='public';" || exit 1
      
      echo "✓ Database test passed"
    env:
    - name: PGPASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "mychart.fullname" . }}-secret
          key: database-password
```

---

### Validation Tests

```yaml
# templates/tests/test-validation.yaml
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "mychart.fullname" . }}-test-validation
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  serviceAccountName: {{ include "mychart.fullname" . }}-test
  containers:
  - name: test
    image: bitnami/kubectl:1.28
    command:
    - sh
    - -c
    - |
      echo "Validating deployment..."
      
      # Check all pods are running
      READY=$(kubectl get deployment {{ include "mychart.fullname" . }} -o jsonpath='{.status.readyReplicas}')
      DESIRED=$(kubectl get deployment {{ include "mychart.fullname" . }} -o jsonpath='{.spec.replicas}')
      
      if [ "$READY" != "$DESIRED" ]; then
        echo "ERROR: Only $READY/$DESIRED pods ready"
        exit 1
      fi
      
      # Check service exists
      kubectl get service {{ include "mychart.fullname" . }} || exit 1
      
      # Check ConfigMap exists
      kubectl get configmap {{ include "mychart.fullname" . }}-config || exit 1
      
      # Check Secret exists
      kubectl get secret {{ include "mychart.fullname" . }}-secret || exit 1
      
      echo "✓ Validation test passed"
```

---

## 3. Chart Management

### Chart Versioning (SemVer)

**Semantic Versioning: MAJOR.MINOR.PATCH**

```yaml
# Chart.yaml
apiVersion: v2
name: myapp
version: 1.2.3  # Chart version
appVersion: "2.5.1"  # Application version

# Version increments:
# MAJOR (1.0.0 → 2.0.0): Breaking changes
# MINOR (1.2.0 → 1.3.0): New features (backwards compatible)
# PATCH (1.2.3 → 1.2.4): Bug fixes
```

**Version bump guidelines:**

```bash
# Patch: Bug fix in templates
1.2.3 → 1.2.4
# Example: Fix typo in ConfigMap template

# Minor: Add new feature
1.2.4 → 1.3.0
# Example: Add optional Ingress support

# Major: Breaking change
1.3.0 → 2.0.0
# Example: Change required values structure
```

**Managing versions:**

```bash
# Update Chart.yaml version
sed -i 's/^version: .*/version: 1.2.4/' Chart.yaml

# Package chart
helm package myapp/
# Creates: myapp-1.2.4.tgz

# Update chart index
helm repo index . --url https://charts.example.com
```

---

### Chart Repositories

#### Harbor (Recommended for Enterprise)

```bash
# Install Harbor (includes ChartMuseum)
helm repo add harbor https://helm.goharbor.io
helm install harbor harbor/harbor

# Add Harbor as Helm repo
helm repo add mycompany https://harbor.example.com/chartrepo/myproject \
  --username admin \
  --password Harbor12345

# Push chart to Harbor
helm push myapp-1.2.4.tgz oci://harbor.example.com/myproject

# Or using Harbor API
helm package myapp/
curl -u admin:Harbor12345 \
  --data-binary "@myapp-1.2.4.tgz" \
  https://harbor.example.com/api/chartrepo/myproject/charts
```

#### ChartMuseum (Simple, Lightweight)

```bash
# Install ChartMuseum
helm repo add chartmuseum https://chartmuseum.github.io/charts
helm install chartmuseum chartmuseum/chartmuseum \
  --set env.open.STORAGE=local \
  --set env.open.DISABLE_API=false

# Add ChartMuseum repo
helm repo add myrepo http://chartmuseum.example.com

# Push chart
curl --data-binary "@myapp-1.2.4.tgz" \
  http://chartmuseum.example.com/api/charts

# Or use helm-push plugin
helm plugin install https://github.com/chartmuseum/helm-push
helm cm-push myapp/ myrepo
```

#### JFrog Artifactory

```bash
# Add Artifactory repo
helm repo add artifactory https://artifactory.example.com/artifactory/helm-local \
  --username user \
  --password password

# Push chart
curl -u user:password \
  -T myapp-1.2.4.tgz \
  "https://artifactory.example.com/artifactory/helm-local/myapp-1.2.4.tgz"

# Or use Artifactory API
helm package myapp/
jfrog rt upload myapp-1.2.4.tgz helm-local/
```

#### GitHub Pages (Free, Public)

```bash
# Create gh-pages branch
git checkout --orphan gh-pages
git rm -rf .

# Package charts
helm package ../myapp/

# Create index
helm repo index . --url https://mycompany.github.io/helm-charts/

# Commit and push
git add .
git commit -m "Add myapp-1.2.4"
git push origin gh-pages

# Add repo
helm repo add mycompany https://mycompany.github.io/helm-charts/
```

---

### Signing Charts

**Sign charts for security and authenticity:**

```bash
# Generate GPG key
gpg --full-generate-key

# List keys
gpg --list-keys

# Package and sign chart
helm package myapp/ --sign --key 'Your Name' --keyring ~/.gnupg/secring.gpg

# Creates:
# - myapp-1.2.4.tgz
# - myapp-1.2.4.tgz.prov (provenance file)

# Verify signed chart
helm verify myapp-1.2.4.tgz

# Install with verification
helm install myapp myapp-1.2.4.tgz --verify
```

**Provenance file contains:**

- Chart hash
- Chart.yaml contents
- GPG signature
- Verification instructions

---

### Chart Dependencies Management

```yaml
# Chart.yaml
dependencies:
  - name: postgresql
    version: "~12.1.0"
    repository: https://charts.bitnami.com/bitnami
  - name: redis
    version: "^17.0.0"
    repository: https://charts.bitnami.com/bitnami
```

```bash
# Update dependencies
helm dependency update ./myapp

# This creates:
# - charts/postgresql-12.1.5.tgz
# - charts/redis-17.3.7.tgz
# - Chart.lock

# List dependencies
helm dependency list ./myapp

# Build from Chart.lock
helm dependency build ./myapp
```

**Chart.lock (version locking):**

```yaml
dependencies:
- name: postgresql
  repository: https://charts.bitnami.com/bitnami
  version: 12.1.5
- name: redis
  repository: https://charts.bitnami.com/bitnami
  version: 17.3.7
digest: sha256:abc123def456...
generated: "2024-11-14T10:00:00Z"
```

---

## 4. Helmfile

**Helmfile** manages multiple Helm releases declaratively.

### Installation

```bash
# macOS
brew install helmfile

# Linux
wget https://github.com/helmfile/helmfile/releases/download/v0.157.0/helmfile_linux_amd64
chmod +x helmfile_linux_amd64
sudo mv helmfile_linux_amd64 /usr/local/bin/helmfile

# Verify
helmfile version
```

---

### Managing Multiple Releases

```yaml
# helmfile.yaml
repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: ingress-nginx
    url: https://kubernetes.github.io/ingress-nginx
  - name: jetstack
    url: https://charts.jetstack.io

releases:
  # PostgreSQL database
  - name: postgres
    namespace: database
    chart: bitnami/postgresql
    version: ~12.1.0
    values:
      - values/postgres.yaml
    set:
      - name: auth.password
        value: {{ requiredEnv "POSTGRES_PASSWORD" }}
  
  # Redis cache
  - name: redis
    namespace: cache
    chart: bitnami/redis
    version: ^17.0.0
    values:
      - values/redis.yaml
    needs:
      - database/postgres
  
  # Application
  - name: myapp
    namespace: default
    chart: ./charts/myapp
    version: 1.2.3
    values:
      - values/myapp-common.yaml
      - values/myapp-{{ .Environment.Name }}.yaml
    secrets:
      - values/secrets.yaml
    needs:
      - database/postgres
      - cache/redis
  
  # Ingress controller
  - name: ingress-nginx
    namespace: ingress
    chart: ingress-nginx/ingress-nginx
    version: 4.8.0
    values:
      - values/ingress.yaml
  
  # Cert-manager
  - name: cert-manager
    namespace: cert-manager
    chart: jetstack/cert-manager
    version: 1.13.0
    set:
      - name: installCRDs
        value: true
```

**Commands:**

```bash
# Sync all releases
helmfile sync

# Sync specific release
helmfile -l name=myapp sync

# Apply (only changed releases)
helmfile apply

# Diff (show changes)
helmfile diff

# Template (render without applying)
helmfile template

# Destroy all releases
helmfile destroy

# List releases
helmfile list
```

---

### Environment Management

```yaml
# helmfile.yaml
environments:
  dev:
    values:
      - environments/dev/values.yaml
    secrets:
      - environments/dev/secrets.yaml
  
  staging:
    values:
      - environments/staging/values.yaml
    secrets:
      - environments/staging/secrets.yaml
  
  production:
    values:
      - environments/production/values.yaml
    secrets:
      - environments/production/secrets.yaml

releases:
  - name: myapp
    namespace: {{ .Environment.Name }}
    chart: ./charts/myapp
    values:
      - values/common.yaml
      - values/{{ .Environment.Name }}.yaml
    set:
      - name: replicaCount
        value: {{ .Environment.Values.replicaCount }}
      - name: image.tag
        value: {{ .Environment.Values.imageTag }}
```

**Environment files:**

```yaml
# environments/dev/values.yaml
replicaCount: 1
imageTag: latest
ingress:
  host: myapp-dev.example.com

---
# environments/staging/values.yaml
replicaCount: 2
imageTag: v1.2.3-rc1
ingress:
  host: myapp-staging.example.com

---
# environments/production/values.yaml
replicaCount: 5
imageTag: v1.2.3
ingress:
  host: myapp.example.com
```

**Deploy to environment:**

```bash
# Development
helmfile -e dev sync

# Staging
helmfile -e staging sync

# Production
helmfile -e production sync
```

---

### Declarative Desired State

**Complete helmfile.yaml example:**

```yaml
# helmfile.yaml
helmDefaults:
  wait: true
  timeout: 600
  recreatePods: false
  force: false
  atomic: true
  cleanupOnFail: true

repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: mycompany
    url: https://charts.mycompany.com

environments:
  default:
    values:
      - replicaCount: 1
  
  production:
    values:
      - replicaCount: 5

releases:
  # Infrastructure
  - name: postgresql
    namespace: database
    chart: bitnami/postgresql
    version: 12.1.5
    values:
      - |
          auth:
            database: {{ requiredEnv "DB_NAME" }}
            username: {{ requiredEnv "DB_USER" }}
            password: {{ requiredEnv "DB_PASSWORD" }}
          primary:
            persistence:
              size: {{ .Environment.Values.dbStorageSize | default "10Gi" }}
  
  - name: redis
    namespace: cache
    chart: bitnami/redis
    version: 17.3.7
    values:
      - |
          auth:
            password: {{ requiredEnv "REDIS_PASSWORD" }}
          master:
            persistence:
              enabled: false
  
  # Application stack
  - name: backend
    namespace: default
    chart: mycompany/spring-boot-app
    version: 1.2.3
    values:
      - values/backend-common.yaml
      - values/backend-{{ .Environment.Name }}.yaml
    set:
      - name: replicaCount
        value: {{ .Environment.Values.replicaCount }}
      - name: postgresql.enabled
        value: false
      - name: cache.enabled
        value: false
    needs:
      - database/postgresql
      - cache/redis
  
  - name: frontend
    namespace: default
    chart: mycompany/nginx-spa
    version: 1.0.5
    values:
      - values/frontend-{{ .Environment.Name }}.yaml
    set:
      - name: replicaCount
        value: {{ .Environment.Values.replicaCount }}
    needs:
      - default/backend

hooks:
  - events: ["presync"]
    showlogs: true
    command: "kubectl"
    args: ["apply", "-f", "namespaces.yaml"]
  
  - events: ["postsync"]
    showlogs: true
    command: "kubectl"
    args: ["rollout", "status", "deployment/backend"]
```

**Advanced features:**

```yaml
# Layering (modular helmfiles)
helmfiles:
  - infrastructure/helmfile.yaml
  - applications/helmfile.yaml
  - monitoring/helmfile.yaml

# Selectors
releases:
  - name: app1
    labels:
      tier: frontend
      priority: high
  - name: app2
    labels:
      tier: backend
      priority: low

# Deploy by label
# helmfile -l tier=frontend sync

# Templates in values
releases:
  - name: myapp
    values:
      - |
          environment: {{ .Environment.Name }}
          namespace: {{ .Release.Namespace }}
          timestamp: {{ now | date "2006-01-02" }}
```

---

## Summary

### Hooks

- ✅ **Lifecycle intervention**: pre/post install/upgrade/delete
- ✅ **Weights**: Control execution order
- ✅ **Deletion policies**: Cleanup after execution
- ✅ **Use cases**: Migrations, backups, notifications, testing

### Testing

- ✅ **helm test**: Validate deployments
- ✅ **Test pods**: Connection, API, database, validation tests
- ✅ **Hook annotation**: `"helm.sh/hook": test`

### Chart Management

- ✅ **Versioning**: Semantic versioning (MAJOR.MINOR.PATCH)
- ✅ **Repositories**: Harbor, ChartMuseum, Artifactory, GitHub Pages
- ✅ **Signing**: GPG signatures for security
- ✅ **Dependencies**: Chart.lock for reproducible builds

### Helmfile

- ✅ **Multiple releases**: Declarative management
- ✅ **Environments**: dev, staging, production
- ✅ **Dependencies**: Release ordering with `needs`
- ✅ **Templating**: Go templates in helmfile.yaml
- ✅ **Layering**: Modular helmfile organization
